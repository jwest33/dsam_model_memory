{% extends "base.html" %}
{% block content %}
<section class="chat">
  <div class="panel">
    <h3 class="neon-text">Session Configuration</h3>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <label style="color: var(--synth-cyan); font-weight: 600; text-transform: uppercase; font-size: 0.8rem;">Session ID:</label>
      <input id="session" type="text" value="default" style="flex: 1; max-width: 300px;"/>
    </div>
  </div>
  
  <div class="panel">
    <h3 class="neon-text">Chat Interface</h3>
    <div id="messages" style="min-height: 300px; max-height: 400px; overflow-y: auto; margin-bottom: 1rem; padding: 1rem; background: var(--synth-surface); border-radius: 8px; border: 1px solid var(--synth-border);"></div>
    <div style="display: flex; gap: 1rem; align-items: flex-end;">
      <textarea id="input" placeholder="Type your message here..." style="flex: 1;"></textarea>
      <button id="send">Send</button>
    </div>
  </div>
  
  <div id="loading-indicator" class="loading-container" style="display: none;">
    <div class="spinner"></div>
    <div class="loading-text">Processing your query...</div>
  </div>
  
  <div class="panel" id="debug-panel" style="display: none;">
    <h3 class="neon-text">Debug Information</h3>
    <pre id="reply" style="max-height: 200px; overflow-y: auto;"></pre>
  </div>
</section>
<script>
const sendBtn = document.getElementById('send');
const input = document.getElementById('input');
const session = document.getElementById('session');
const replyEl = document.getElementById('reply');
const messagesEl = document.getElementById('messages');
const debugPanel = document.getElementById('debug-panel');
const loadingIndicator = document.getElementById('loading-indicator');
let messages = [];
let isProcessing = false;

function addMessage(role, content) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${role}`;
  messageDiv.innerHTML = `
    <div class="role">${role}</div>
    <div class="content">${content}</div>
  `;
  messagesEl.appendChild(messageDiv);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

sendBtn.onclick = async () => {
  const text = input.value.trim();
  if(!text || isProcessing) return;
  
  // Set processing state
  isProcessing = true;
  
  // Add user message to UI
  addMessage('user', text);
  
  // Show loading indicator
  loadingIndicator.style.display = 'flex';
  sendBtn.disabled = true;
  sendBtn.textContent = 'Processing...';
  input.disabled = true;
  
  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({session_id: session.value, text, messages})
    });
    const data = await res.json();
    messages.push({role:'user', content:text});
    messages.push({role:'assistant', content:data.reply});
    
    // Add assistant message to UI
    addMessage('assistant', data.reply);
    
    // Update debug info if available
    if (data.block?.block) {
      debugPanel.style.display = 'block';
      replyEl.textContent = "Block summary: " + JSON.stringify(data.block.block, null, 2);
    }
    
    input.value = '';
  } catch (error) {
    addMessage('assistant', 'Error: ' + error.message);
  } finally {
    // Hide loading indicator and reset state
    loadingIndicator.style.display = 'none';
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
    input.disabled = false;
    isProcessing = false;
    input.focus();
  }
};

// Allow sending with Enter key when not processing
input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey && !isProcessing) {
    e.preventDefault();
    sendBtn.click();
  }
});
</script>
{% endblock %}
